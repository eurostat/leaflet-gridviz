!function(e,i){"object"==typeof exports&&"object"==typeof module?module.exports=i(require("proj4"),require("gridviz")):"function"==typeof define&&define.amd?define(["proj4","gridviz"],i):"object"==typeof exports?exports.LeafletGridviz=i(require("proj4"),require("gridviz")):e.LeafletGridviz=i(e.proj4,e.gridviz)}(self,(e,i)=>(()=>{var t={48:i=>{"use strict";i.exports=e},448:e=>{"use strict";e.exports=i},718:()=>{L.DomUtil.setTransform=L.DomUtil.setTransform||function(e,i,t){var n=i||new L.Point(0,0);e.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+n.x+"px,"+n.y+"px)":"translate3d("+n.x+"px,"+n.y+"px,0)")+(t?" scale("+t+")":"")},L.GridvizCanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(e){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,this._zooming=!1,L.setOptions(this,e)},delegate:function(e){return this._delegate=e,this},needRedraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this.drawLayer,this)),this},_updatePosition:function(){requestAnimationFrame(()=>{if(null!=this._map&&null!=this._map.containerPointToLayerPoint){var e=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,e)}})},onAdd:function(e){this._map=e,this._canvas=L.DomUtil.create("canvas","leaflet-layer"),this._canvas.style.transformOrigin="0 0",L.DomUtil.addClass(this._canvas,"leaflet-zoom-animated");var i=e.getSize();this._canvas.width=i.x,this._canvas.height=i.y;var t=e.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(t?"animated":"hide"));var n=e.createPane("gridviz");n.style.zIndex=399,n.style.cursor="pointer",n.appendChild(this._canvas),e.on(this.getEvents(),this);var a=this._delegate||this;a.onLayerDidMount&&a.onLayerDidMount(),this._updatePosition(),this._initCanvasLevel(),L.DomUtil.setTransform(this._canvas,L.point(0,0),1),this.needRedraw()},onRemove:function(e){var i=this._delegate||this;i.onLayerWillUnmount&&i.onLayerWillUnmount(),this._frame&&L.Util.cancelAnimFrame(this._frame);var t=e.getPane("gridviz");this._canvas&&this._canvas.parentElement===t&&(t.removeChild(this._canvas),e.off(this.getEvents(),this),this._canvas=null)},_initCanvasLevel:function(){if(this._map){var e=this._map.getZoom(),i=this._map.getCenter(),t=this._map._getTopLeftPoint(i,e).round();this._canvasLevel={zoom:e,origin:t,el:this._canvas}}else console.warn("GridvizCanvasLayer: _initCanvasLevel called before map init")},getEvents:function(){return{resize:this._onLayerDidResize,movestart:this._onMoveStart,moveend:this._onMoveEnd,viewreset:this._onLayerDidMove,zoomstart:this._onZoomStart,zoomanim:this._onAnimZoom,zoomend:this._onZoomEnd}},_onMoveStart:function(e){},_onMoveEnd:function(e){this._onLayerDidMove()},_onLayerDidMove:function(){this._updatePosition(),this.drawLayer()},_onZoomStart:function(){L.DomUtil.setPosition(this._canvas,L.point(0,0)),this._initCanvasLevel()},_onZoomEnd:function(){this._updatePosition(),this._initCanvasLevel()},_onAnimZoom:function(e){var i=this._canvasLevel,t=this._map.getZoomScale(e.zoom,i.zoom),n=i.origin.multiplyBy(t).subtract(this._map._getNewPixelOrigin(e.center,e.zoom)).round();L.Browser.any3d?L.DomUtil.setTransform(i.el,n,t):L.DomUtil.setPosition(i.el,n)},_onLayerDidResize:function(e){this._canvas.width=e.newSize.x,this._canvas.height=e.newSize.y,this._updatePosition(),L.DomUtil.setTransform(this._canvas,L.point(0,0),1),this._initCanvasLevel(),this.drawLayer()},addTo:function(e){return e.addLayer(this),this},drawLayer:function(){this._zooming||(this.onDrawLayer&&this.onDrawLayer(),this._frame=null)}}),L.gridvizCanvasLayer=function(){return new L.GridvizCanvasLayer}}},n={};function a(e){var i=n[e];if(void 0!==i)return i.exports;var o=n[e]={exports:{}};return t[e](o,o.exports,a),o.exports}a.n=e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return a.d(i,{a:i}),i},a.d=(e,i)=>{for(var t in i)a.o(i,t)&&!a.o(e,t)&&Object.defineProperty(e,t,{enumerable:!0,get:i[t]})},a.o=(e,i)=>Object.prototype.hasOwnProperty.call(e,i),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{"use strict";a.r(o),a.d(o,{default:()=>r,registerGridvizLayer:()=>n});var e=a(48),i=a.n(e),t=a(448);function n(e=L){if(!e)throw new Error("Leaflet L is required");if(!i())throw new Error("proj4 is required");if(!t.Map)throw new Error("gridviz.Map is required");if(!e.GridvizCanvasLayer)throw new Error("L.GridvizCanvasLayer not found. Load ./L.GridvizCanvasLayer.js first.");return e.GridvizLayer=function(e){e=e||{},this.proj=e.proj||"EPSG:3035",this.gridvizMap=null,this.onLayerDidMountCallback=e.onLayerDidMountCallback||null,this.onLayerDidMount=function(){this.buildGridvizMap(),this.onLayerDidMountCallback&&this.onLayerDidMountCallback(this.gridvizMap),this.addResizeObserver()},this.addResizeObserver=function(){const e=this._map,i=e._container;new ResizeObserver(i=>{console.log("GridvizLayer: resizeObserver callback",i),Array.isArray(i)&&i.length&&(e.invalidateSize({debounceMoveend:!0}),e.once("resize",i=>{const t=i&&i.newSize?i.newSize:e.getSize(),n=0|t.x,a=0|t.y;this.gridvizMap.w===n&&this.gridvizMap.h===a||(this.gridvizMap.w=n,this.gridvizMap.h=a,this.gridvizMap.geoCanvas.w=n,this.gridvizMap.geoCanvas.h=a,this.gridvizMap.geoCanvas.offscreenCanvas.width=n,this.gridvizMap.geoCanvas.offscreenCanvas.height=a,this._canvas.setAttribute("width",""+n),this._canvas.setAttribute("height",""+a),this._updatePosition(),L.DomUtil.setTransform(this._canvas,L.point(0,0),1),this._initCanvasLevel(),this.gridvizMap.redraw(),this.needRedraw())}))}).observe(i)},this.onLayerWillUnmount=function(){this.gridvizMap.destroy()},this.setData=function(e){this.needRedraw()},this.onDrawLayer=function(e){if(this._zooming)return;const i=this.leafletToGeoCenter(this._map.getCenter()),t=this.leafletZoomToGridvizZoom();this.gridvizMap.setView(i[0],i[1],t),this.gridvizMap.redraw()},this.leafletToGeoCenter=function(e){return i()(this.proj,[e.lng,e.lat])},this.leafletZoomToGridvizZoom=function(){return this.getMetresPerPixel()},this.getMetresPerPixel=function(){const e=this._map.getCenter(),i=this._map.latLngToContainerPoint(e),t=[i.x+1,i.y],n=this._map.containerPointToLatLng(i),a=this._map.containerPointToLatLng(t),o=this.leafletToGeoCenter(n);return this.leafletToGeoCenter(a)[0]-o[0]},this.buildGridvizMap=function(){const i=this.leafletToGeoCenter(this._map.getCenter());e.container=e.container||this._canvas.parentElement,this.gridvizMap=new t.Map(e.container,{canvas:this._canvas,w:window.innerWidth,h:window.innerHeight,x:i[0],y:i[1],z:this.leafletZoomToGridvizZoom(),disableZoom:!0,transparentBackground:!0,selectionRectangleColor:e.selectionRectangleColor,selectionRectangleWidthPix:e.selectionRectangleWidthPix,legendContainer:e.legendContainer,tooltip:{parentElement:document.body}})}},e.GridvizLayer.prototype=new e.GridvizCanvasLayer,e.GridvizLayer}a(718),i().defs("EPSG:3035")||i().defs("EPSG:3035","+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs"),"undefined"!=typeof window&&window.L&&!window.L.GridvizLayer&&n(window.L);const r=n})(),o})());