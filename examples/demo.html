<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>demo</title>

        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
            integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
            crossorigin=""
        />

        <style>
            #map {
                height: 98vh;
                width: 100%;
            }
            #tooltip_eurostat {
                z-index: 99999999999999;
            }
        </style>
    </head>
    <body>
        <script src="../build/leaflet-gridviz.min.js"></script>

        <div id="map"></div>

        <script>
            async function main() {
                // get 3035 basemap capabilities
                const response = await fetch(
                    'https://ec.europa.eu/statistical-atlas/arcgis/rest/services/Basemaps/StatAtlas_Continents_2021_3035/MapServer?f=pjson'
                )
                const basemap = await response.json()

                let resolutions = []
                for (let i = 0; i < basemap.tileInfo.lods.length; i++) {
                    resolutions.push(basemap.tileInfo.lods[i].resolution)
                }
                console.log('resolutions', resolutions)

                // define 3035
                let crs = new L.Proj.CRS(
                    'EPSG:3035',
                    '+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs +type=crs',
                    {
                        origin: [basemap.tileInfo.origin.x, basemap.tileInfo.origin.y],
                        bounds: L.bounds(
                            L.point(basemap.fullExtent.xmin, basemap.fullExtent.ymin),
                            L.point(basemap.fullExtent.xmax, basemap.fullExtent.ymax)
                        ),
                        resolutions: resolutions,
                        tileSize: basemap.tileInfo.rows,
                    }
                )
                crs.distance = L.CRS.Earth.distance
                crs.R = 6378137

                // create leaflet map
                var map = new L.Map('map', {
                    crs: crs,
                    center: ['50.00754', '19.98211'],
                    fadeAnimation: false,
                    zoomSnap: 0.25,
                    maxBounds: {
                        _northEast: {
                            lat: -38,
                            lng: 173,
                        },
                        _southWest: {
                            lat: -57,
                            lng: -152,
                        },
                    },
                    maxBoundsViscosity: 1,
                    maxZoom: 7,
                    minZoom: 2,
                    touchZoom: true, // TODO: fix map freezes when pinched
                    zoom: 3,
                    zoomAnimation: false, //causes issues when changing between pie charts and choropleths when enabled
                    zoomControl: false,
                })

                // add basemap
                L.tileLayer(
                    'https://ec.europa.eu/statistical-atlas/arcgis/rest/services/Basemaps/StatAtlas_Continents_2021_3035/MapServer/tile/{z}/{y}/{x}',
                    {
                        maxZoom: 19,
                        errorTileUrl: 'assets/image/error-tile.png',
                        noWrap: true,
                        opacity: 1,
                        tileSize: 256,
                        tms: false,
                    }
                ).addTo(map)

                // add gridviz
                gridvizLayer = new L.GridvizLayer()
                gridvizLayer.addTo(map)
            }

            main()
        </script>
    </body>
</html>
